import numpy
from numpy import pi, exp, log, cos, logaddexp
import scipy.stats

"""
Data generated with:
numpy.random.seed(1)
numpy.random.poisson(10**numpy.random.normal(1, 1, size=1000))
"""
data_all = numpy.array([  
         414,     2,     2,     0,    83,     0,   537,     2,    27,
           5,   276,     0,     3,     3,   124,     2,     9,     2,
          14,    36,     0,   124,    75,    42,    82,     4,     5,
           0,     4,    35,     3,     8,     2,     1,     1,    14,
           0,    11,   469,    52,     5,     0,     4,   480,    11,
           5,     9,  1262,     4,    28,    18,     4,     3,     3,
           9,    31,    55,    76,    20,    70,     0,   180,    28,
           1,    31,    10,   158,   319,  1493,     0,     1,     4,
          16,    73,    21,     0,     5,    76,     8,    72,     7,
           3,    13,    19,    13,     7,     1,    25,    18,   146,
         164,    21,     8,     3,    18,    13,     4,    12,     0,
          47,     7,   160,    27,    34,     1,    14,    64,     1,
           2,    10,     0,     9,    66,     4,    21,     0,    11,
           1,   113,    32,    11,     2,   194,   908,     1,   182,
         405,    18,     1,    70,     4,     1,     1,    31,    90,
           5,    44,     3,    69,    11,     5,    10,    77,    64,
          30,    19,    16,    37,    20,    53,     8,     0,    90,
        1449,    26,     6,    10,    17,    13,     1,     4,     1,
          15,     7,    36,     4,    98,    18,  1584,     0,     0,
          82,  3401,     9,    15,     3,   209,     5,    47,     7,
           1,    20,    33,   193,     6,     1,    46,    17,    20,
           6,   147,    21,   797,   127,    59,     0,    39,    21,
          59,   109,     6,    66,     2,   916,     1,     0,     1,
           0,     0,   897,    10,     1,   115,     2,     0,    75,
          42,     4,   243,    18,   417,    37,   343,    14,     0,
        2819,     2,     5,     3,     9,    15,    18,    46,   629,
           6,     0,     0,     2,     1,    60,     4,     1,     6,
           0,     0,    45,    41,     2,   641,     0,     4,     6,
           0,   847,    26,     0,  1117,    42,    36,     2,     8,
           0,    71,     5,    15,   151,    22,    19,    12,     1,
          68,   349,    59,    72,     2,     1,     0,   169,     3,
         227,     3,     4,     8,    83,    13,    20,    10,    16,
           1,    11,     4,    12,    35,     4,     7,     2,    27,
          64,     1,    45,  1146,     0,     0,     0,     7,   412,
           9,     1,    59,     5,   134,    17,   234,     2, 10818,
          73,    60,    12,     1,     3,    12,     0,    15,     2,
          44,    84,     2,   158,     8,   147,    24,   139,     2,
           6,   280,     3,     0,     0,     0,     0,     3,   170,
           0,    23,     4,     9,     9,     2,    18,     1,   103,
          76,     7,    58,     0,     0,    12,     5,     3,     4,
           1,    73,     0,    22,     6,    48,    31,     0,    46,
          20,    11,     2,    82,     6,   669,    34,  1338,     1,
           0,    44,    72,     7,     0,     4,    39,     8,     7,
           8,     0,     3,     0,   631,     1,    20,     2,    54,
           0,    64,     7,  1274,     2,    13,    30,   152,     2,
           7,     1,     1,    14,   114,     7,  1115,   552,     4,
           0,     0,     1,   131,    30,     0,     5,   405,     6,
           4,  1114,    10,     4,    17,    14,     3,   173,   136,
          61,     8,   146,    11,    20,   114,    58,   602,    30,
           1,     1,   253,     9,    20,     3,    95,     4,   287,
           4,   122,    53,     3,   135,     1,     1,    62,     3,
           1,     5,     2,   109,    37,     8,     6,    23,   563,
          68,     3,    77,     6,     2,   715,     1,     2,     1,
           1,    35,     1,    43,     1,     0,    49,   279,    33,
         158,   524,   112,     2,     6,    44,     7,    28,     0,
           2,    31,     0,     1,    14,     0,    15,     2,     3,
           3,    18,     0,    11,     0,    34,   497,    15,    11,
           2,    45,     1,     2,    34,    13,   129,   272,     4,
           7,   587,    84,    47,   214,     2,    46,   263,   406,
           3,     5,    20,     8,     5,    49,     1,     2,    25,
           3,     4,     0,    87,     0,     0,     5,   162,   220,
           0,    10,     0,    97,     0,     9,   108,     8,   276,
           4,    27,    75,     7,   234,    33,     1, 90748,    61,
           9,     1,     7,     6,    53,    26,   718,    12,    37,
          14,    10,     6,   135,    67,     0,     1,    10,   135,
           6,   559,     2,    15,     0,     1,     8,    30,   479,
          12,   307,    43,    98,     4,   223,     1,    31,     0,
           4,     0,     0,    20,     8,     1,   322,    21,   106,
          65,     3,     0,     4,   169,     1,    62,     0,    31,
           0,   159,     4,    89,    20,    61,    12,    48,     1,
           0,    60,     8,     3,     8,    24,     4,    30,     0,
           7,   105,   121,     1,    74,     0,    58,     0,     0,
           2,     1,   240,    70,   396,   181,     3,     6,   113,
           6,     9,     0,     9,     0,     4,     1,    48,     2,
           4,   232,     0,    16,     0,     9,    21,    68,     0,
          18,    23,    10,    13,    39,    22,     1,     0,  3237,
         836,     1,    33,    39,    55,    15,     1,     8,     4,
          16,     3,     7,   101,   180,     0,     6,     2,   157,
          10,   237,     2,    10,     1,   191,     3,     0,     0,
           0,     3,    14,    22,   334,     5,    64,    16,     6,
           0,    81,     3,    14,     0,    24,    12,    10,     5,
         108,   106,    43, 20737,     1,     7,     0,    33,     2,
           0,     0,     9,   108,     0,     3,     7,     0,    22,
          12,    24,     2,   344,     6,   200,     4,    46,     2,
           0,     3,     8,     3,   342,     2,     0,   544,    38,
           1,    27,    18,     0,     6,     9,    58,    73,    10,
         124,     8,     0,     0,    38,     0,    45,     2,     2,
          34,   169,     0,     0,    13,     2,    82,     0,    27,
          34,    10,   123,     0,   123,     4,    47,     3,    71,
          59,     0,    17,     9,     7,     1,   730,    22,   360,
           2,     2,    14,     6,  2494,    22,   146,    10,     5,
           9,    20,    64,     7,     0,     1,     7,    31,    20,
           6,     1,     9,    41,     8,    13,     6,    96,     4,
          16,    23,    55,   344,    45,    39,     0,    34,  1988,
           4,     0,     3,    93,    32,     2,     8,    84,    46,
        2732,   115,    23,    28,     5,     1,    21,    33,     0,
           3,     5,    23,     8,    27,    16,   137,     0,   421,
         263,    15,    40,    45,     2,    10,    53,    15,   130,
          13,    11,     2,     4,     2,   523,    20,     0,    24,
           8,     0,    32,     1,    39,     0,     1,    30,     0,
           7,    13,    34,    56,     9,     0,   874,     2,   637,
           0,   114,    90,     1,    41,    67,    60,     4,    22,
           4,     0,    94,     5,   238,    25,     1,    11,     4,
           3,    31,     7,   406,    79,     2,     3,     6,     0,
          93,    89,    89,     3,   139,     5,    87,   640,     9,
           0,     3,    42,   149,     1,     3,    12,    37,    87,
           1,     7,    91,    29,    33,   125,    13,    42,     1,
           1,     0,    11,     7,     4,    24,     0,     9,     6,
           0,     0,   276,    21,     0,     3,    24,     6,    40,
           2,    13,     4,     4,     2,    15,    75,     1,     1,
          12,     6,    18,    51,   202,     8,     0,     9,    23,     2])

data2_all = numpy.array([
       13,  9,  9,  4, 10,  3, 15, 12, 11, 12, 21,  8,  7, 16, 16,  4, 14,
        3, 10, 10,  5, 11, 10, 16, 11, 10,  6,  6, 10, 21, 10,  7,  6,  2,
       10, 12, 10, 10, 18, 11,  9,  6,  6, 12,  7,  4, 15, 18, 15, 12, 13,
       11,  6,  6, 14, 11, 16, 17, 15, 13,  6, 15,  9, 11,  8, 12, 11, 11,
       15, 13,  5,  7, 21, 20, 15,  7,  7, 15, 13, 18, 13, 11, 11, 12, 14,
        2,  7,  8, 12, 12, 12, 15, 18,  7, 13, 10,  9, 12,  9, 13, 14, 13,
       12, 12, 10, 13, 11,  8,  8, 14,  6,  4, 16, 10, 14,  9, 12, 13, 15,
        7,  7,  8, 18, 16,  6, 18, 11,  7,  6, 10, 12,  9,  6, 11, 16,  7,
        3,  4,  9,  6,  8, 11,  8, 15,  9,  9, 12,  9, 15, 13, 11,  6, 12,
       19, 10,  7,  9,  8, 10,  7,  8,  7, 10,  8, 18, 13, 15, 11, 11,  3,
       10,  8, 18, 10, 18,  9, 11, 18, 12,  7, 12,  7, 15, 15,  7,  8, 14,
       18, 12,  9, 12,  9, 20, 15, 11,  2, 11, 12,  9,  8,  5, 12,  8, 15,
        8,  7,  3,  6,  7, 21,  7,  8, 17, 10,  9, 14, 11,  6, 11, 14, 15,
       10, 16, 12,  5, 23,  9,  8,  9,  8,  8,  9, 12, 22,  6,  4,  5,  6,
        3, 10,  6,  9,  9, 13,  9,  7, 15, 10, 16, 11,  6,  8, 11, 15,  8,
       10, 16, 16, 17,  8, 13,  6,  6, 11,  8, 16,  8,  8,  9,  8, 17, 17,
       14,  8,  6,  5,  8, 10,  8, 10, 10,  6, 11, 17, 16, 10, 12, 12,  6,
       14, 13,  9,  6,  6, 14,  5,  6, 17,  7, 14, 17,  5,  8, 12,  7, 14,
        7,  8, 20, 10, 15, 13, 17, 12, 28,  8, 13,  4, 13,  6, 15,  4, 16,
        9,  8, 15, 11, 14,  7,  6,  9, 11,  9,  8, 14,  8,  3,  4,  7,  4,
        9, 15,  9,  4,  9, 10, 11, 16, 15,  5,  8,  7, 14, 14,  6, 10, 12,
        4, 14, 15,  6,  9,  5,  8, 10,  6,  9,  4, 16, 11, 15, 15,  7, 10,
       13, 10, 17,  7,  6, 10, 14, 11,  7, 12, 15, 13, 10, 10,  7,  8,  7,
       20,  6,  6,  6, 15,  3,  9, 10, 12,  6, 10,  9, 10, 10,  7,  5,  9,
       15, 10,  2, 12, 17,  8,  4,  2, 12, 13,  7,  6,  9, 15,  7,  6, 14,
       16,  7, 13, 14,  7, 12, 15, 14,  9, 15, 14, 12, 11,  8, 11, 15,  8,
       11,  9, 18, 16, 11, 16,  7, 17,  9, 13, 11, 18,  9,  8,  8, 10, 11,
        6,  9,  5, 15,  8,  9, 11, 11, 21, 14,  7, 11, 13,  6, 13,  8,  3,
        9,  3,  9, 12, 11, 13, 12,  4, 10, 21, 14, 13, 15,  5, 11,  9,  4,
       13,  9,  7, 10,  7, 11,  8,  6, 14,  5,  3,  8, 15,  8,  7,  9, 11,
       11,  7,  9, 11, 15,  6,  4,  8,  9, 16,  8,  8, 12, 15,  8, 18, 19,
        7,  7, 12, 18,  7,  6, 13, 10,  4,  9,  9,  8, 10,  7,  4,  7, 11,
        4,  7,  7, 14,  8,  5,  5,  4, 10,  5, 11, 11, 10, 14,  4, 13, 10,
       10, 11, 11,  4, 24, 12,  9,  5,  6, 12, 12, 14, 13,  8,  8, 11,  7,
       13, 21, 11,  9,  5, 11, 20, 10, 15, 10, 11,  9,  9, 16, 13,  9, 13,
       16, 16, 13,  6, 23, 10, 11, 10, 13, 13, 11, 12, 11,  8, 16,  6, 16,
       15,  2,  7,  9, 15,  9, 18,  6, 14,  6, 16,  8, 11,  6,  7, 11, 16,
       10,  4, 11, 11, 12,  2,  8, 10, 17,  5, 13, 16, 12, 11, 13,  5, 22,
        5,  9,  9,  9, 12, 14, 17, 13,  6,  9, 17, 10,  8,  3, 15,  6, 13,
        6,  8,  3, 16, 15,  6, 13, 10, 14, 10, 15,  9, 10,  9, 12, 10,  9,
       10, 12,  9, 19, 17,  9, 10, 18,  8, 10,  5, 11, 10, 10, 10, 11, 16,
       13,  8,  9,  9, 10,  3, 15,  5, 10,  6, 14, 10,  9, 11,  2,  9, 11,
        8, 11, 10, 12, 11, 18,  6, 14, 10, 12,  8, 10, 17,  6, 15,  9, 17,
       11, 24,  4,  5,  7,  5,  8,  7,  8, 10, 16,  3,  5,  9, 12, 13,  9,
       11, 11, 15, 13,  9,  8, 10, 11,  8,  7, 12, 11, 23,  7,  9, 16, 11,
        8, 10, 11,  4, 11, 12, 24, 13,  9, 13,  5, 12,  8, 11, 10, 16,  6,
       10, 12, 18,  7,  3, 10, 16, 11,  6, 16,  9,  6, 15,  6, 14,  5, 11,
        8, 12, 16,  7, 17,  4, 13,  7, 13, 11, 16,  5, 10,  8, 15, 17, 16,
       13,  3,  8, 11, 11, 14,  7, 14,  6,  5,  8,  7,  9,  6, 13, 10,  8,
        2, 11, 13,  8, 19, 14,  8, 17, 19, 13,  3, 18, 19,  6,  7,  5, 13,
       12, 11,  8,  8, 10, 11, 19, 11,  8,  6,  4, 15,  7, 13,  8, 11,  2,
       10, 13,  4, 11,  9, 11,  7, 10, 12,  7,  9, 10,  5,  9, 16,  6, 18,
        7, 11, 11, 15,  7,  8,  7,  4,  3,  6,  5, 12,  6,  5, 13,  8, 13,
       10, 11,  9, 12,  8, 20,  7, 12,  5,  9,  6,  3, 14,  6, 11, 12, 12,
        8,  4, 22, 11, 14, 11,  7, 11,  5,  7, 17, 12, 20, 11,  8, 10,  8,
        5, 14,  7,  9, 11,  9,  7, 14, 18, 14,  7, 14, 18, 20, 13, 10,  9,
       18,  9,  6,  8, 18,  7, 15,  8,  9, 15,  6,  6,  4,  7, 14,  4,  9,
        8,  7, 12,  8,  2, 18, 15,  5, 13,  8,  8, 17,  7,  9,  9,  6,  9,
       14, 12,  6,  9,  9, 17, 13, 19, 11, 13,  6, 14, 12, 11])


def create_problem_bexvar(**config):
	ndim = config.get('ndim', 2)
	assert ndim > 2
	ndata = ndim - 2
	variance = config.get('variance', 1)
	data = {1:data_all[:ndata], -1: data2_all[:ndata]}[variance]
	# numpy.random.poisson(10**numpy.random.normal(1, 1, size=1000))
	
	def loglikelihood(u):
		u = numpy.asarray(u)
		popmean   = u[0] * 6 - 3
		popstd    = 10**(u[1] * 6 - 3)
		instrates = u[2:] * 6 - 3
		# upper level: log-gaussian over the instantaneous rates
		l = (-0.5 * ((instrates - popmean)/popstd)**2 - 0.5 * log(popstd**2 * 2 * pi)).sum()
		# lower level: measured poisson counts
		l += scipy.stats.poisson.logpmf(data, 10**instrates).sum()
		return l
	config['Z_analytic'] = 0
	config['loglikelihood'] = loglikelihood
	config['description'] = """
	Hierarchical model of count data. The count rate varies from measurement to measurement according to a lognormal (10^(1+-1)), giving a variance larger than poissonian.
	The intrinsic count rates for each of the measurements and the overall mean+std are sought simultaneously (%d parameters).
	
	<p>This problem is difficult because it creates a funnel shape,
	and the parameter contours are poissonian (so not elliptical).
	
	<p>Analytic value not verified.
	""" % ndim
	return config

